================================================================================
BACKEND SYNC REQUIRED - ADMIN ROLE LIMITS
================================================================================

OVERVIEW:
The frontend has been updated to enforce stricter role limits:
- SuperAdmin: Maximum 2 accounts
- Admin: Maximum 1 account (changed from 2)

CHANGES REQUIRED IN BACKEND:
--------------------------------------------------------------------------------

1. UPDATE AUTH SIGNUP VALIDATION (controller/authController.js)

   Add validation in the signup endpoint to check role limits BEFORE creating user:

   ```javascript
   // In signup function, before creating new user
   
   const validateRoleLimits = async (roles) => {
     // Count existing users by role
     const allUsers = await User.find({});
     
     let superAdminCount = 0;
     let adminCount = 0;
     
     allUsers.forEach(user => {
       if (user.roles && user.roles.SuperAdmin) {
         superAdminCount++;
       }
       if (user.roles && user.roles.Admin) {
         adminCount++;
       }
     });
     
     // Check if new user would exceed limits
     if (roles.SuperAdmin && superAdminCount >= 2) {
       throw new Error('Maximum of 2 SuperAdmin accounts allowed');
     }
     
     if (roles.Admin && adminCount >= 1) {
       throw new Error('Maximum of 1 Admin account allowed');
     }
   };
   
   // Call before creating user:
   await validateRoleLimits(roles);
   ```


2. UPDATE USER UPDATE VALIDATION (controller/userController.js or authController.js)

   Add validation when updating user roles:

   ```javascript
   // In user update function
   
   const validateRoleLimitsForUpdate = async (userId, newRoles) => {
     // Get all users EXCEPT the one being edited
     const allUsers = await User.find({ _id: { $ne: userId } });
     
     let superAdminCount = 0;
     let adminCount = 0;
     
     allUsers.forEach(user => {
       if (user.roles && user.roles.SuperAdmin) {
         superAdminCount++;
       }
       if (user.roles && user.roles.Admin) {
         adminCount++;
       }
     });
     
     // Check if updated roles would exceed limits
     if (newRoles.SuperAdmin && superAdminCount >= 2) {
       throw new Error('Maximum of 2 SuperAdmin accounts allowed');
     }
     
     if (newRoles.Admin && adminCount >= 1) {
       throw new Error('Maximum of 1 Admin account allowed');
     }
   };
   
   // Call before updating:
   await validateRoleLimitsForUpdate(userId, newRoles);
   ```


3. EXAMPLE IMPLEMENTATION FOR /auth/signup ENDPOINT

   ```javascript
   exports.signup = async (req, res) => {
     try {
       const { username, email, password, roles, contactNumber } = req.body;
       
       // Validate required fields
       if (!username || !email || !password) {
         return res.status(400).json({ 
           message: 'Username, email, and password are required' 
         });
       }
       
       // Check if user already exists
       const existingUser = await User.findOne({ 
         $or: [{ username }, { email }] 
       });
       
       if (existingUser) {
         return res.status(409).json({ 
           message: 'Username or email already exists' 
         });
       }
       
       // VALIDATE ROLE LIMITS
       if (roles) {
         const allUsers = await User.find({});
         
         let superAdminCount = 0;
         let adminCount = 0;
         
         allUsers.forEach(user => {
           if (user.roles && user.roles.SuperAdmin) superAdminCount++;
           if (user.roles && user.roles.Admin) adminCount++;
         });
         
         if (roles.SuperAdmin && superAdminCount >= 2) {
           return res.status(400).json({ 
             message: 'Maximum of 2 SuperAdmin accounts allowed. Please remove an existing SuperAdmin first.' 
           });
         }
         
         if (roles.Admin && adminCount >= 1) {
           return res.status(400).json({ 
             message: 'Maximum of 1 Admin account allowed. Please remove the existing Admin first.' 
           });
         }
       }
       
       // Hash password
       const hashedPassword = await bcrypt.hash(password, 10);
       
       // Create new user
       const newUser = new User({
         username,
         email,
         password: hashedPassword,
         roles: roles || {},
         contactNumber: contactNumber || ''
       });
       
       await newUser.save();
       
       res.status(201).json({ 
         message: 'User created successfully',
         userId: newUser._id 
       });
       
     } catch (error) {
       console.error('Signup error:', error);
       res.status(500).json({ 
         message: error.message || 'Error creating user' 
       });
     }
   };
   ```


4. EXAMPLE IMPLEMENTATION FOR USER UPDATE ENDPOINTS

   Apply this validation to all user update endpoints:
   - PUT /users/:id
   - PATCH /users/:id
   - PUT /auth/update/:id
   - PATCH /auth/update/:id
   - PUT /auth/users/:id
   - PATCH /auth/users/:id

   ```javascript
   exports.updateUser = async (req, res) => {
     try {
       const { id } = req.params;
       const { roles, ...otherFields } = req.body;
       
       // If roles are being updated, validate limits
       if (roles) {
         // Get all users EXCEPT the one being edited
         const allUsers = await User.find({ _id: { $ne: id } });
         
         let superAdminCount = 0;
         let adminCount = 0;
         
         allUsers.forEach(user => {
           if (user.roles && user.roles.SuperAdmin) superAdminCount++;
           if (user.roles && user.roles.Admin) adminCount++;
         });
         
         if (roles.SuperAdmin && superAdminCount >= 2) {
           return res.status(400).json({ 
             message: 'Maximum of 2 SuperAdmin accounts allowed. Please remove an existing SuperAdmin first.' 
           });
         }
         
         if (roles.Admin && adminCount >= 1) {
           return res.status(400).json({ 
             message: 'Maximum of 1 Admin account allowed. Please remove the existing Admin first.' 
           });
         }
       }
       
       // Update user
       const updatedUser = await User.findByIdAndUpdate(
         id,
         { ...otherFields, ...(roles && { roles }) },
         { new: true }
       );
       
       if (!updatedUser) {
         return res.status(404).json({ message: 'User not found' });
       }
       
       res.status(200).json({ 
         message: 'User updated successfully',
         user: updatedUser 
       });
       
     } catch (error) {
       console.error('Update user error:', error);
       res.status(500).json({ 
         message: error.message || 'Error updating user' 
       });
     }
   };
   ```


5. VERIFICATION STEPS

   Test the following scenarios:

   a) Creating SuperAdmin:
      - Create 1st SuperAdmin → Should succeed ✅
      - Create 2nd SuperAdmin → Should succeed ✅
      - Create 3rd SuperAdmin → Should fail with error message ❌
   
   b) Creating Admin:
      - Create 1st Admin → Should succeed ✅
      - Create 2nd Admin → Should fail with error message ❌
   
   c) Updating User Roles:
      - Edit existing user to add Admin role when 1 Admin exists → Should fail ❌
      - Edit existing user to add SuperAdmin role when 2 SuperAdmins exist → Should fail ❌
      - Edit existing Admin to remove Admin role → Should succeed ✅
      - Edit existing user to add Admin role after above → Should succeed ✅
   
   d) Error Messages:
      - Should return clear error messages
      - Frontend should display these errors in toast notifications


6. DATABASE CONSIDERATIONS

   If you need to check current role counts in production:

   ```javascript
   // MongoDB query to count current roles
   db.users.aggregate([
     {
       $project: {
         username: 1,
         email: 1,
         isSuperAdmin: { $ifNull: ["$roles.SuperAdmin", false] },
         isAdmin: { $ifNull: ["$roles.Admin", false] }
       }
     },
     {
       $group: {
         _id: null,
         superAdminCount: { $sum: { $cond: ["$isSuperAdmin", 1, 0] } },
         adminCount: { $sum: { $cond: ["$isAdmin", 1, 0] } }
       }
     }
   ])
   ```


7. LOGGING & MONITORING

   Add logging for role limit violations:

   ```javascript
   // When limit is exceeded
   console.warn(`Role limit exceeded: Attempted to create ${roleName} when limit is ${limit}`);
   
   // Log to security logs
   await SecurityLog.create({
     action: 'ROLE_LIMIT_EXCEEDED',
     attemptedRole: roleName,
     currentCount: count,
     limit: limit,
     timestamp: new Date()
   });
   ```


================================================================================
CRITICAL NOTES:
================================================================================

1. The Admin role limit changed from 2 to 1
2. SuperAdmin limit remains at 2
3. These limits apply to CREATION and ROLE UPDATES
4. Validation must happen BEFORE database operations
5. Error messages must be clear and user-friendly
6. Backend must return proper HTTP status codes (400 for validation errors)


================================================================================
FRONTEND CHANGES COMPLETED:
================================================================================

✅ AddAdminModal: Updated to enforce max 1 Admin, max 2 SuperAdmin
✅ EditAdminModal: Updated to enforce same limits when changing roles
✅ Client-side validation prevents exceeding limits
✅ User-friendly error messages displayed

STATUS: Frontend changes complete. Backend sync required for enforcement.


================================================================================
SECURITY CONSIDERATION:
================================================================================

Frontend validation is NOT sufficient for security. Backend MUST enforce these
limits to prevent:
- API manipulation
- Direct database writes
- Bypassing frontend validation

Backend enforcement is MANDATORY for this feature to be secure.

================================================================================
